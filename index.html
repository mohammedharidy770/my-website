<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Time Map</title>
  <!-- ÙØ§ÙÙŠÙƒÙˆÙ† Ù…Ù† Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ -->
  <link rel="icon" href="https://img.icons8.com/?size=100&id=11764&format=png&color=228BE6" type="image/png">
<style>
:root{
--bg:#0a192f;
--card:#112240;
--muted:#a0bcd8;
--accent:#64ffda;
--glass:rgba(255,255,255,0.03);
--prayer-bg: rgba(100,255,218,0.08);
--prayer-border: rgba(100,255,218,0.25);
--done-bg: rgba(100,255,218,0.22);
--highlight:#64ffda;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg),#05020a);color:#eceff8;padding:16px}
header{text-align:center;margin-bottom:14px}
h1{font-size:22px;margin-bottom:6px}
.lead{color:var(--muted);font-size:13px;margin-bottom:12px}
.app{max-width:1200px;margin:0 auto;display:flex;gap:14px;align-items:flex-start}
.main{flex:1}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:12px}
.btn{padding:10px 14px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:inherit}
.btn.primary{background:linear-gradient(180deg,rgba(164,108,255,0.18),transparent);border-color:rgba(164,108,255,0.35)}
.small{font-size:13px;padding:6px 10px}
.timeline{display:flex;flex-direction:column;gap:8px;position:relative}
.slot{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;transition:background 0.3s ease,color 0.3s ease}
.slot .left{display:flex;flex-direction:column;align-items:flex-end}
.slot .left strong{font-size:15px}
.slot .left small{color:var(--muted)}
.slot .time small{color:var(--muted);font-size:13px}
.slot.study{cursor:pointer;background:transparent}
.slot.done{background:var(--done-bg);color:#fff;text-decoration:line-through}
.slot.prayer{background:var(--prayer-bg);border-color:var(--prayer-border);color:var(--accent);font-weight:700;justify-content:center;cursor:default}
.slot.break{background:rgba(255,255,255,0.01);font-style:italic;color:var(--muted)}
.slot.highlight{background:var(--highlight);animation:flash 0.8s ease-in-out}
@keyframes flash{0%{background:var(--highlight);}50%{background:var(--card);}100%{background:var(--highlight);} }
aside{width:360px}
.label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,textarea,select{width:100%;padding:10px;border-radius:8px;background:#0a0710;border:1px solid rgba(255,255,255,0.03);color:inherit;margin-bottom:10px}
.summary{margin-top:10px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;font-size:14px;color:var(--muted)}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{width:calc(100% - 40px);max-width:640px;background:linear-gradient(180deg,#12031b,#0b0512);border-radius:12px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.7);color:#fff}
.modal h3{margin:0 0 8px 0;color:var(--accent)}
.modal .content{color:var(--muted);margin-bottom:12px}
.modal .actions{display:flex;justify-content:flex-end;gap:8px}
.notice{display:none;position:sticky;top:8px;z-index:999;margin-bottom:8px;padding:10px 12px;background:var(--notice-bg);border-radius:8px;color:#fff;font-weight:700;box-shadow:0 8px 20px rgba(0,0,0,0.6);text-align:center}
.timerBar{height:10px;background:rgba(255,255,255,0.06);border-radius:6px;overflow:hidden;margin-top:8px}
.timerFill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#9be7ff)}
.controls-right{margin-left:auto;display:flex;gap:8px;align-items:center}
@media(max-width:900px){ .app{flex-direction:column} aside{width:100%} .modal{width:92%} }
</style>
</head>
<body>
<header>
  <h1>Ù†Ø¸Ù‘Ù… ÙŠÙˆÙ…Ùƒ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¢Ù†</h1>
  <div class="lead">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…" ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ Ø³ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù…Ø¯Ø© 8 Ø³Ø§Ø¹Ø§Øª Ù…Ø°Ø§ÙƒØ±Ø© (Ù…ÙˆØ²Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§). Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ø¯Ù…Ø¬Ø© ÙˆØ¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©. ØªÙ…Ù‘Øª Ø¥Ø¶Ø§ÙØ© Ø­ÙØ¸/Ø§Ø³ØªØ¹Ø§Ø¯Ø©ØŒ ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŒ Ù…Ø¤Ù‚Øª_SLOTØŒ ÙˆØ¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨.</div>
</header>

<div class="app">
  <main class="main">
    <div class="card">
      <div class="controls">
        <button class="btn primary" id="startBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="btn" id="regenBtn">ğŸ” Ø£Ø¹Ø¯ ØªÙˆØ²ÙŠØ¹</button>
        <div class="controls-right">
          <button class="btn" id="saveScheduleBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
          <button class="btn" id="loadScheduleBtn">ğŸ“‚ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
          <button class="btn" id="exportBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none">
        </div>
        <div style="margin-left:auto" class="small" id="status">Ø¬Ø§Ù‡Ø²</div>
      </div>

      <div id="notice" class="notice"></div>

      <div id="timeline" class="timeline">
        <div style="color:var(--muted);text-align:center;padding:20px">Ù„Ù… ØªØ¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯ â€” Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.</div>
      </div>

      <div class="timerBar" title="ØªÙ‚Ø¯Ù… Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©"><div id="timerFill" class="timerFill"></div></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
        <div class="summary" id="todaySummary" style="margin-top:12px">Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…: â€” Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯</div>
        <div style="text-align:right;color:var(--muted);font-size:13px">
          <div id="currentSlotLabel">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ØºÙ„ Ø§Ù„Ø¢Ù†</div>
          <div id="currentTimer" style="font-weight:700">00:00:00</div>
        </div>
      </div>
    </div>
  </main>

  <aside>
    <div class="card">
      <h4>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h4>
      <label class="label">Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
      <input type="number" id="prayerDuration" value="30">
      <label class="label">Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
      <input type="number" id="breakMinutes" value="15">
      <label class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</label>
      <input type="text" id="cityInput" value="Cairo">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" id="applyBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="btn" id="notifyPermBtn">ğŸ”” Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>
      </div>
      <div class="summary" style="margin-top:8px">Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ³Ù…Ø­ Ø¨Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙŠÙˆÙ… Ø­ØªÙ‰ Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ØªØ¸Ù‡Ø± Ø¹Ù„Ù‰ Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨ Ø¥Ù† Ø³Ù…Ø­Øª Ø§Ù„Ù…ØªØµÙØ­.</div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ â€” Ø§ÙƒØªØ¨Ù‡Ø§ Ù‡Ù†Ø§</h4>
      <label class="label">Ø§ÙƒØªØ¨ Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±</label>
      <textarea id="appointments" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø§Ù„Ø®Ù…ÙŠØ³ 6 Ù…Ø³Ø§Ø¡Ù‹"></textarea>
      <button class="btn primary" id="saveAppointments">ğŸ’¾ Ø§Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
      <div class="summary" style="margin-top:8px">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙˆØ³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.</div>
    </div>

    <div class="card" style="margin-top:12px" id="swapSubjectsCard">
      <h4>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h4>
      <label class="label">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</label>
      <input type="number" id="swapIndex1" min="1" placeholder="Ù…Ø«Ø§Ù„: 1">
      <label class="label">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</label>
      <input type="number" id="swapIndex2" min="1" placeholder="Ù…Ø«Ø§Ù„: 5">
      <label class="label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù€16 Ù…Ø§Ø¯Ø©</label>
      <select id="newSubjectSelect">
        <option value="">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø©</option>
        <option value="Ø±ÙŠØ§Ø¶Ø©">Ø±ÙŠØ§Ø¶Ø©</option>
        <option value="Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ">Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</option>
        <option value="ÙÙŠØ²ÙŠØ§Ø¡">ÙÙŠØ²ÙŠØ§Ø¡</option>
        <option value="ÙƒÙŠÙ…ÙŠØ§Ø¡">ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
        <option value="Ø£Ø­ÙŠØ§Ø¡">Ø£Ø­ÙŠØ§Ø¡</option>
        <option value="Ù‚Ø±Ø¢Ù†">Ù‚Ø±Ø¢Ù†</option>
        <option value="Ø­Ø¯ÙŠØ«">Ø­Ø¯ÙŠØ«</option>
        <option value="ØªÙØ³ÙŠØ±">ØªÙØ³ÙŠØ±</option>
        <option value="ØªÙˆØ­ÙŠØ¯">ØªÙˆØ­ÙŠØ¯</option>
        <option value="ÙÙ‚Ù‡">ÙÙ‚Ù‡</option>
        <option value="ØµØ±Ù">ØµØ±Ù</option>
        <option value="Ø£Ø¯Ø¨">Ø£Ø¯Ø¨</option>
        <option value="Ù†ØµÙˆØµ">Ù†ØµÙˆØµ</option>
        <option value="ØªØ¹Ø¨ÙŠØ±">ØªØ¹Ø¨ÙŠØ±</option>
        <option value="Ø¨Ù„Ø§ØºØ©">Ø¨Ù„Ø§ØºØ©</option>
        <option value="Ù†Ø­Ùˆ">Ù†Ø­Ùˆ</option>
      </select>
      <button class="btn primary" id="swapBtn">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø©</button>
      <div class="summary" style="margin-top:8px">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¨Ø¯ÙŠÙ„ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ù…Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "ØªØ¨Ø¯ÙŠÙ„ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø©". Ø§Ø®ØªØµØ§Ø±Ø§Øª: Space Ù„ØªØ¹Ù„ÙŠÙ…/Ø¥Ù„ØºØ§Ø¡ØŒ R Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹.</div>
    </div>
  </aside>
</div>

<!-- Ù…Ù„Ù Ø§Ù„ØµÙˆØª: Ping ÙˆØ§Ø¶Ø­ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª -->
<audio id="pingAudio" preload="auto" src="https://www.soundjay.com/button/sounds/beep-07.mp3"></audio>

<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h3>Ø§Ù†ØªÙ‡Øª 8 Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© â€” ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
    <div id="modalContent" class="content">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div class="actions">
      <button class="btn" id="closeModal">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
// ======= Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =======
const SUBJECT_POOL = [
  {name:'Ø±ÙŠØ§Ø¶Ø©', dur:120},{name:'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', dur:120},{name:'ÙÙŠØ²ÙŠØ§Ø¡', dur:120},{name:'ÙƒÙŠÙ…ÙŠØ§Ø¡', dur:120},{name:'Ø£Ø­ÙŠØ§Ø¡', dur:120},
  {name:'Ù‚Ø±Ø¢Ù†', dur:60},{name:'Ø­Ø¯ÙŠØ«', dur:60},{name:'ØªÙØ³ÙŠØ±', dur:60},{name:'ØªÙˆØ­ÙŠØ¯', dur:60},{name:'ÙÙ‚Ù‡', dur:60},
  {name:'ØµØ±Ù', dur:60},{name:'Ø£Ø¯Ø¨', dur:60},{name:'Ù†ØµÙˆØµ', dur:60},{name:'ØªØ¹Ø¨ÙŠØ±', dur:60},{name:'Ø¨Ù„Ø§ØºØ©', dur:60},{name:'Ù†Ø­Ùˆ', dur:60}
];

// ======= Ø¹Ù†Ø§ØµØ± DOM =======
const startBtn = document.getElementById('startBtn');
const regenBtn = document.getElementById('regenBtn');
const statusEl = document.getElementById('status');
const timelineEl = document.getElementById('timeline');
const todaySummaryEl = document.getElementById('todaySummary');
const prayerDurationInput = document.getElementById('prayerDuration');
const breakMinutesInput = document.getElementById('breakMinutes');
const cityInput = document.getElementById('cityInput');
const applyBtn = document.getElementById('applyBtn');
const appointmentsInput = document.getElementById('appointments');
const saveAppointmentsBtn = document.getElementById('saveAppointments');
const swapBtn = document.getElementById('swapBtn');
const noticeEl = document.getElementById('notice');
const pingAudio = document.getElementById('pingAudio');
const saveScheduleBtn = document.getElementById('saveScheduleBtn');
const loadScheduleBtn = document.getElementById('loadScheduleBtn');
const exportBtn = document.getElementById('exportBtn');
const importFile = document.getElementById('importFile');
const notifyPermBtn = document.getElementById('notifyPermBtn');
const timerFill = document.getElementById('timerFill');
const currentSlotLabel = document.getElementById('currentSlotLabel');
const currentTimer = document.getElementById('currentTimer');

// ======= helpers =======
function pad(n){ return String(n).padStart(2,'0'); }
function toTime(mins){ const h=Math.floor(mins/60); const m=mins%60; return `${pad(h)}:${pad(m)}`; }
function hhmmToMinutes(str){ if(!str) return null; const match = str.match(/(\d{1,2}):(\d{2})/); if(!match) return null; return parseInt(match[1],10)*60 + parseInt(match[2],10); }

function formatHMS(ms){ if(ms<0) ms=0; const s=Math.floor(ms/1000)%60; const m=Math.floor(ms/60000)%60; const h=Math.floor(ms/3600000); return `${pad(h)}:${pad(m)}:${pad(s)}`; }

// ======= Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ =======
const APPOINT_KEY = 'nazem_day_appointments_v1';
const SCHEDULE_KEY = 'nazem_day_schedule_v1';
function loadAppointments(){ const raw = localStorage.getItem(APPOINT_KEY); if(raw) appointmentsInput.value = raw; }
function saveAppointments(){ localStorage.setItem(APPOINT_KEY, appointmentsInput.value); alert('ØªÙ… Ø­ÙØ¸ Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ù…Ø­Ù„ÙŠÙ‹Ø§'); }
saveAppointmentsBtn.addEventListener('click', saveAppointments);
loadAppointments();

function saveScheduleToStorage(schedule){ localStorage.setItem(SCHEDULE_KEY, JSON.stringify(schedule)); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ù„ÙŠÙ‹Ø§'); }
function loadScheduleFromStorage(){ const raw = localStorage.getItem(SCHEDULE_KEY); if(!raw) return null; try{ return JSON.parse(raw);}catch(e){console.warn('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†',e); return null;} }

saveScheduleBtn.addEventListener('click', ()=>{ if(!currentSchedule) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ø­ÙØ¸Ù‡'); saveScheduleToStorage(currentSchedule); });
loadScheduleBtn.addEventListener('click', ()=>{ const loaded = loadScheduleFromStorage(); if(!loaded) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù…Ø­ÙÙˆØ¸'); applyLoadedSchedule(loaded); alert('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†'); });
exportBtn.addEventListener('click', ()=>{ if(!currentSchedule) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±'); const data = JSON.stringify(currentSchedule, null, 2); const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download = `nazem_schedule_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); });
importFile.addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ try{ const parsed = JSON.parse(reader.result); applyLoadedSchedule(parsed); alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­'); }catch(err){alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­');} }; reader.readAsText(f); });

notifyPermBtn.addEventListener('click', async ()=>{
  if(!('Notification' in window)) return alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨');
  const perm = await Notification.requestPermission(); alert('Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª: '+perm);
});

// ======= Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª =======
function makeStudySlot(subject,start,finish){
  const el = document.createElement('div'); el.className='slot study';
  const left = document.createElement('div'); left.className='left';
  const strong = document.createElement('strong'); strong.innerText=subject;
  const small = document.createElement('small'); small.innerText=`${toTime(start)} - ${toTime(finish)}`;
  left.appendChild(strong); left.appendChild(small);
  el.appendChild(left);
  el.addEventListener('click', ()=>{ el.classList.toggle('done'); updateSummaries(); });
  return el;
}
function makePrayerSlot(name,start,finish){
  const el = document.createElement('div'); el.className='slot prayer';
  el.innerText=`${name} â€” ${toTime(start)} - ${toTime(finish)}`;
  return el;
}
function makeBreakSlot(start,finish){
  const el = document.createElement('div'); el.className='slot break';
  el.innerText=`Ø§Ø³ØªØ±Ø§Ø­Ø© â€” ${toTime(start)} - ${toTime(finish)}`;
  return el;
}

// ======= ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ =======
let currentSchedule = null;
function updateSummaries(){
  if(!currentSchedule) return;
  const studySlots = currentSchedule.studySlots.filter(s=>s.type==='study');
  const done = studySlots.filter((s,i)=>{
    const el = timelineEl.querySelectorAll('.slot.study')[i];
    return el && el.classList.contains('done');
  }).length;
  todaySummaryEl.innerText = `Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…: ${done} Ù…Ù† ${studySlots.length} Ù…Ø§Ø¯Ø© ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡Ø§`;
}

// ======= Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ù† Aladhan =======
async function fetchPrayerTimingsForCity(city){
  const country = 'Egypt';
  try{
    const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=2`;
    const res = await fetch(url);
    const json = await res.json();
    if(json && json.data && json.data.timings){
      const t = json.data.timings;
      return { Fajr: t.Fajr, Dhuhr: t.Dhuhr, Asr: t.Asr, Maghrib: t.Maghrib, Isha: t.Isha };
    }
  }catch(e){ console.error('prayer API error', e); }
  return null;
}

// ======= Ù…Ø³Ø¬Ù„Ø§Øª Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­ØªÙ‰ Ù„Ø§ ØªØªÙƒØ±Ø± =======
let scheduledTimers = []; // Ù„ØªØ®Ø²ÙŠÙ† setTimeout ids
let playedPrayers = new Set();
let slotTimerInterval = null;
let autoAdvance = true; // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ù†Ù†ØªÙ‚Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§

startBtn.addEventListener('click', ()=>{ startDay(); });

// ÙˆØ¸ÙŠÙØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ ØµÙ„Ø§Ø©)
function notifyUser(title, body){
  // Notification API
  if('Notification' in window && Notification.permission === 'granted'){
    try{ new Notification(title, { body }); }catch(e){/* ignore */}
  }
  // ØµÙˆØª
  try{ pingAudio.currentTime = 0; pingAudio.play().catch(()=>{}); }catch(e){}
}

function triggerPrayerAlert(prayerName){
  if(playedPrayers.has(prayerName)) return;
  playedPrayers.add(prayerName);
  noticeEl.innerText = `ğŸ•Œ Ø­Ø§Ù† Ø§Ù„Ø¢Ù† Ù…ÙˆØ¹Ø¯ ØµÙ„Ø§Ø© ${prayerName}`;
  noticeEl.style.display = 'block';
  notifyUser('Ù…ÙˆØ¹Ø¯ ØµÙ„Ø§Ø©', `Ø­Ø§Ù† Ø§Ù„Ø¢Ù† Ù…ÙˆØ¹Ø¯ ØµÙ„Ø§Ø© ${prayerName}`);
  setTimeout(()=>{ noticeEl.style.display = 'none'; }, 10000);
}

// ======= Ø¨Ø¯Ø¡ Ø§Ù„ÙŠÙˆÙ… Ù…Ø¹ Ù…ÙˆØ§Ù‚ÙŠØª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆÙ‚Ø·Ø¹ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© =======
async function startDay(){
  // ØªÙ†Ø¸ÙŠÙ Ù…Ø¤Ù‚ØªØ§Øª Ø³Ø§Ø¨Ù‚Ø©
  scheduledTimers.forEach(id=>clearTimeout(id)); scheduledTimers = [];
  playedPrayers.clear();
  if(slotTimerInterval) clearInterval(slotTimerInterval);

  statusEl.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...';
  const prayerDur = Number(prayerDurationInput.value) || 30;
  const breakMinDefault = Number(breakMinutesInput.value) || 5;
  const seed = (new Date()).toISOString().slice(0,10);
  const subjects = pickSubjects(seed);
  const now = new Date();
  const startMinutes = now.getHours()*60 + now.getMinutes();
  const dayWindowEnd = startMinutes + 8*60;

  const headerNote = document.createElement('div');
  headerNote.style.color='var(--muted)';
  headerNote.style.textAlign='center';
  headerNote.style.padding='6px 0';
  headerNote.innerText=`Ø§Ù†Ø·Ù„Ù‚ Ù…Ù†: ${pad(now.getHours())}:${pad(now.getMinutes())} â€” Ù…Ø¯Ø© Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: 8 Ø³Ø§Ø¹Ø§Øª`;

  // Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª
  const city = (cityInput.value || 'Cairo').trim();
  const apiTimings = await fetchPrayerTimingsForCity(city);
  const prayerNamesMap = { Fajr:'Ø§Ù„ÙØ¬Ø±', Dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', Asr:'Ø§Ù„Ø¹ØµØ±', Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨', Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡' };
  const prayersList = [];

  if(apiTimings){
    for(const key of ['Fajr','Dhuhr','Asr','Maghrib','Isha']){
      const hhmm = apiTimings[key];
      const mins = hhmmToMinutes(hhmm);
      if(mins !== null){ if(mins >= startMinutes && mins < dayWindowEnd){ prayersList.push({name:prayerNamesMap[key], mins}); } }
    }
    prayersList.sort((a,b)=>a.mins-b.mins);
  }

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const schedule = [];
  let current = startMinutes;

  for(let i=0;i<subjects.length && current < dayWindowEnd;i++){
    let subj = subjects[i];
    let remaining = subj.dur;
    while(remaining > 0 && current < dayWindowEnd){
      const nextPrayerIndex = prayersList.findIndex(p => p.mins >= current && p.mins < dayWindowEnd);
      const nextPrayer = nextPrayerIndex !== -1 ? prayersList[nextPrayerIndex] : null;

      if(nextPrayer && nextPrayer.mins < current + remaining){
        const studyEnd = nextPrayer.mins;
        if(studyEnd > current){ schedule.push({type:'study', subject:subj.name, start:current, finish:studyEnd}); remaining -= (studyEnd - current); current = studyEnd; }
        schedule.push({type:'prayer', name: nextPrayer.name, start: current, finish: current + prayerDur});
        current += prayerDur; prayersList.splice(nextPrayerIndex,1);
      } else {
        const studyEnd = Math.min(current + remaining, dayWindowEnd);
        if(studyEnd > current){ schedule.push({type:'study', subject:subj.name, start:current, finish:studyEnd}); remaining -= (studyEnd - current); current = studyEnd; } else { remaining = 0; }
      }
    }
    if(i < subjects.length - 1 && current < dayWindowEnd && breakMinDefault > 0){ schedule.push({type:'break', start: current, finish: Math.min(current + breakMinDefault, dayWindowEnd)}); current += breakMinDefault; }
  }

  // Ø£ÙŠ ØµÙ„Ø§Ø© Ù…ØªØ¨Ù‚ÙŠØ©
  for(const p of prayersList.slice()){
    if(p.mins >= startMinutes && p.mins < dayWindowEnd && p.mins >= current){ if(p.mins > current) current = p.mins; schedule.push({type:'prayer', name:p.name, start:current, finish:current + prayerDur}); current += prayerDur; }
  }

  // Ø¹Ø±Ø¶
  timelineEl.innerHTML = '';
  timelineEl.appendChild(headerNote);
  for(const s of schedule){ let slotEl; if(s.type==='study'){ slotEl = makeStudySlot(s.subject,s.start,s.finish); } else if(s.type==='break'){ slotEl = makeBreakSlot(s.start,s.finish); } else if(s.type==='prayer'){ slotEl = makePrayerSlot(s.name,s.start,s.finish); } timelineEl.appendChild(slotEl); }

  currentSchedule = {studySlots: schedule};
  updateSummaries();
  statusEl.innerText = `Ø§Ù„ÙŠÙˆÙ… Ø¬Ø§Ø±ÙŠ â€” Ù…ÙˆØ§Ù‚ÙŠØª Ù…Ù†: ${city}`;

  // Ø¬Ø¯ÙˆÙ„Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙ„Ø§Ø©
  const nowMs = Date.now();
  schedule.forEach(s => {
    if(s.type === 'prayer'){
      const today = new Date();
      const target = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, s.start, 0, 0);
      const delay = target.getTime() - nowMs;
      if(delay >= 0){ const id = setTimeout(()=> { triggerPrayerAlert(s.name); }, delay); scheduledTimers.push(id); }
      else { if((Date.now() - target.getTime()) < 60*1000){ triggerPrayerAlert(s.name); } }
    }
  });

  // Ø´ØºÙ‘Ù„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  startSlotTimer();
}

// ======= Ù…Ø¤Ù‚Øª Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆAuto-advance =======
function startSlotTimer(){
  if(!currentSchedule) return;
  if(slotTimerInterval) clearInterval(slotTimerInterval);
  const now = new Date();
  const nowMins = now.getHours()*60 + now.getMinutes();

  // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø£ÙˆÙ„ Ø´Ø±ÙŠØ­Ø© ÙÙŠÙ‡Ø§ Ø²Ù…Ø§Ù† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ø¢Ù†)
  let idx = currentSchedule.studySlots.findIndex(s => s.finish > nowMins);
  if(idx === -1) idx = currentSchedule.studySlots.length - 1;

  function update(){
    const now2 = new Date(); const nowMs = now2.getTime(); const nowMins2 = now2.getHours()*60 + now2.getMinutes();
    // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±Ø§Ø¦Ø­ Ù…Ø¬Ø¯Ø¯Ù‹Ø§ Ù…Ø¹ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const slots = timelineEl.querySelectorAll('.slot');
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ø§Ù…
    const totalStudy = currentSchedule.studySlots.filter(s=>s.type==='study').reduce((a,b)=>a+(b.finish-b.start),0);
    const doneStudy = Array.from(slots).filter(el=>el.classList.contains('done')).length;
    const progressPercent = Math.min(100, Math.round((doneStudy / Math.max(1, currentSchedule.studySlots.filter(s=>s.type==='study').length)) * 100));
    timerFill.style.width = progressPercent + '%';

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª
    const slotIdx = currentSchedule.studySlots.findIndex(s => s.finish > nowMins2);
    let current = null; if(slotIdx !== -1) current = currentSchedule.studySlots[slotIdx];
    if(current){
      currentSlotLabel.innerText = `${current.type==='study'? current.subject : (current.type==='prayer'? current.name : 'Ø§Ø³ØªØ±Ø§Ø­Ø©')} â€” ${toTime(current.start)}-${toTime(current.finish)}`;
      const slotEnd = new Date(now2.getFullYear(), now2.getMonth(), now2.getDate(), 0, current.finish, 0, 0).getTime();
      const remainingMs = slotEnd - nowMs;
      currentTimer.innerText = formatHMS(remainingMs);

      // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø´Ø±ÙŠØ­Ø© (ÙˆÙ‚Øª Ø³Ø§Ù„Ø¨) ÙˆØ§Ù†Øª Ù„Ø³Ø© Ø¬ÙˆÙ‘Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      if(remainingMs <= 0){
        // Ø¥Ù† Ù„Ù… ØªØªÙ… ÙˆØ³Ù…Ù‡Ø§ ÙƒÙ€ done ÙˆÙƒØ§Ù†Øª Ø¯Ø±Ø§Ø³Ø© ÙÙ†Ø¯Ø§Ø¡ Ø¥Ø´Ø¹Ø§Ø±
        if(current.type==='study'){
          // Ø¥Ø°Ø§ autoAdvance true â†’ Ù†Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ø¥Ù†ØªÙ‡Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ†Ù†ØªÙ‚Ù„
          if(autoAdvance){
            // ÙˆØ³Ù… Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ…ÙƒØªÙ…Ù„
            const studyEls = timelineEl.querySelectorAll('.slot.study');
            const el = studyEls[slotIdx]; if(el && !el.classList.contains('done')) el.classList.add('done');
            updateSummaries();
            // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù†Ø­Ø±Ùƒ Ø§Ù„ØªØ±ÙƒÙŠØ² Ù„Ù„Ø´Ø±ÙŠØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
            // Ù†ØªØ±Ùƒ Ù„Ù„Ø³Ø·Ø± Ø§Ù„ØªØ§Ù„ÙŠ Ù„ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø±Ùƒ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ù„Ø§ Ù†ØºÙŠØ± Ø§Ù„ØªÙˆÙ‚ÙŠØª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ Ù‡Ù†Ø§)
          }
        }
      }
    } else {
      currentSlotLabel.innerText = 'Ø§Ù†ØªÙ‡Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù€8 Ø³Ø§Ø¹Ø§Øª';
      currentTimer.innerText = '00:00:00';
      timerFill.style.width = '100%';
    }
  }

  update();
  slotTimerInterval = setInterval(update, 1000);
}

// ======= ØªØ¨Ø¯ÙŠÙ„ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¯ =======
swapBtn.addEventListener('click', ()=>{
  if(!currentSchedule) return alert('Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯.');
  const idx1 = parseInt(document.getElementById('swapIndex1').value)-1;
  const idx2 = parseInt(document.getElementById('swapIndex2').value)-1;
  const newSubj = document.getElementById('newSubjectSelect').value;
  const studySlots = currentSchedule.studySlots.filter(s=>s.type==='study');
  if(isNaN(idx1) || idx1<0 || idx1>=studySlots.length) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø§Ø¯Ø© ØµØ­ÙŠØ­Ø©');
  if(idx2!==-1 && (isNaN(idx2) || idx2<0 || idx2>=studySlots.length)) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø§Ø¯Ø© Ø«Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©');

  if(newSubj){ studySlots[idx1].subject = newSubj; studySlots[idx1].highlight=true; }
  if(!newSubj && idx2!==-1){ const temp=studySlots[idx1].subject; studySlots[idx1].subject=studySlots[idx2].subject; studySlots[idx2].subject=temp; }

  // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù…
  timelineEl.innerHTML = '';
  const headerNote = document.createElement('div'); headerNote.style.color='var(--muted)'; headerNote.style.textAlign='center'; headerNote.style.padding='6px 0';
  const now = new Date(); headerNote.innerText=`Ø§Ù†Ø·Ù„Ù‚ Ù…Ù†: ${pad(now.getHours())}:${pad(now.getMinutes())} â€” Ù…Ø¯Ø© Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: 8 Ø³Ø§Ø¹Ø§Øª`;
  timelineEl.appendChild(headerNote);

  currentSchedule.studySlots.forEach((s,i)=>{ let slotEl; if(s.type==='study'){ slotEl = makeStudySlot(s.subject,s.start,s.finish); if(s.highlight){ slotEl.classList.add('highlight'); setTimeout(()=>slotEl.classList.remove('highlight'),800); s.highlight=false; } } else if(s.type==='break'){ slotEl = makeBreakSlot(s.start,s.finish); } else if(s.type==='prayer'){ slotEl = makePrayerSlot(s.name,s.start,s.finish); } timelineEl.appendChild(slotEl); });

  updateSummaries();
  alert('ØªÙ… ØªØ­Ø¯ÙŠØ« / ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
});

// ======= Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ø¹ Ø¶Ù…Ø§Ù† 8 Ø³Ø§Ø¹Ø§Øª + Animation =======
regenBtn.addEventListener('click', async ()=>{
  if(!currentSchedule) return alert('Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯.');
  const seed = (new Date()).toISOString().slice(0,10) + '_regen';
  const pickedSubjects = pickSubjects(seed);
  const heavyNames = ['Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ','Ø±ÙŠØ§Ø¶ÙŠØ§Øª','ÙÙŠØ²ÙŠØ§Ø¡','Ø£Ø­ÙŠØ§Ø¡'];
  const heavySubjects = pickedSubjects.filter(s=>heavyNames.includes(s.name));
  const lightSubjects = pickedSubjects.filter(s=>!heavyNames.includes(s.name));
  function shuffleArray(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]] = [a[j],a[i]]; } return a; }
  const shuffledHeavy = shuffleArray(heavySubjects); const shuffledLight = shuffleArray(lightSubjects);
  const newSubjects = []; let hi=0, li=0;
  for(let i=0;i<pickedSubjects.length;i++){
    if(i%2===0){ if(hi < shuffledHeavy.length) newSubjects.push({...shuffledHeavy[hi++]}); else newSubjects.push({...shuffledLight[li++]}); }
    else { if(li < shuffledLight.length) newSubjects.push({...shuffledLight[li++]}); else newSubjects.push({...shuffledHeavy[hi++]}); }
  }

  newSubjects.forEach(s=>{ if(heavyNames.includes(s.name)) s.dur = 120; else s.dur = 60; });

  // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡
  const breakMinDefault = Number(breakMinutesInput.value) || 15;
  let current = currentSchedule.studySlots[0].start || (new Date().getHours()*60 + new Date().getMinutes());
  const prayers = currentSchedule.studySlots.filter(s=>s.type==='prayer');
  const newSchedule = [];

  for(let i=0;i<newSubjects.length;i++){
    const subj = newSubjects[i]; let remaining = subj.dur;
    while(remaining > 0){
      const nextPrayer = prayers.find(p=>p.start >= current);
      if(nextPrayer && nextPrayer.start < current + remaining){
        const studyEnd = nextPrayer.start; if(studyEnd > current){ newSchedule.push({type:'study', subject:subj.name, start:current, finish:studyEnd}); remaining -= (studyEnd - current); current = studyEnd; }
        newSchedule.push({...nextPrayer}); current += nextPrayer.finish - nextPrayer.start;
      } else { const studyEnd = current + remaining; newSchedule.push({type:'study', subject:subj.name, start:current, finish:studyEnd}); current = studyEnd; remaining = 0; }
    }
    if(i < newSubjects.length-1){ newSchedule.push({type:'break', start:current, finish:current+breakMinDefault}); current += breakMinDefault; }
  }

  currentSchedule.studySlots = newSchedule;

  // Ø±Ø³Ù… Ù…Ø¹ Animation
  timelineEl.innerHTML = '';
  const headerNote = document.createElement('div'); headerNote.style.color='var(--muted)'; headerNote.style.textAlign='center'; headerNote.style.padding='6px 0';
  const now = new Date(); headerNote.innerText=`Ø§Ù†Ø·Ù„Ù‚ Ù…Ù†: ${pad(now.getHours())}:${pad(now.getMinutes())} â€” Ù…Ø¯Ø© Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: 8 Ø³Ø§Ø¹Ø§Øª`;
  timelineEl.appendChild(headerNote);

  currentSchedule.studySlots.forEach(s=>{ let slotEl; if(s.type==='study'){ slotEl = makeStudySlot(s.subject,s.start,s.finish); slotEl.classList.add('highlight'); setTimeout(()=>slotEl.classList.remove('highlight'),800); }
  else if(s.type==='break'){ slotEl = makeBreakSlot(s.start,s.finish); } else if(s.type==='prayer'){ slotEl = makePrayerSlot(s.name,s.start,s.finish); } timelineEl.appendChild(slotEl); });

  updateSummaries();
  saveScheduleToStorage(currentSchedule);
  alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© 8 Ø³Ø§Ø¹Ø§Øª Ù…Ø¹ Animation ÙˆØ§Ù„Ù…Ø¯Ø¯ Ø§Ù„ØµØ­ÙŠØ­Ø©.');
});

applyBtn.addEventListener('click',()=>{ startDay(); alert('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'); });

// ======= Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ =======
function seededRandom(seed){ let s=0; for(let i=0;i<seed.length;i++){ s = (s * 31 + seed.charCodeAt(i)) >>> 0; } return function(){ s = (s ^ (s<<13)) >>> 0; s = (s ^ (s>>>17)) >>> 0; s = (s ^ (s<<5)) >>> 0; return (s >>> 0) / 4294967295; } }
function shuffleWithSeed(arr, seed){ const rnd = seededRandom(seed); const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

function pickSubjects(seed){ const shuffled = shuffleWithSeed(SUBJECT_POOL, seed + '_pool'); const picks = []; let sum = 0; const TARGET = 8 * 60; for(const s of shuffled){ if(sum + s.dur > TARGET) continue; picks.push({...s}); sum += s.dur; if(sum === TARGET) break; }
  if(sum < TARGET){ const smalls = shuffleWithSeed(SUBJECT_POOL.filter(x=>x.dur<=60), seed+'_extras'); let idx = 0; while(sum < TARGET){ const item = smalls[idx % smalls.length]; if(sum + item.dur <= TARGET){ picks.push({...item}); sum += item.dur; } else break; idx++; if(idx>200) break; } }
  return picks; }

// ======= Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯Ù‡ Ø£Ùˆ Ù…Ø­ÙÙˆØ¸ =======
function applyLoadedSchedule(loaded){
  if(!loaded || !loaded.studySlots) return alert('Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ ØµØ§Ù„Ø­');
  currentSchedule = loaded;
  timelineEl.innerHTML = '';
  const headerNote = document.createElement('div'); headerNote.style.color='var(--muted)'; headerNote.style.textAlign='center'; headerNote.style.padding='6px 0';
  const now = new Date(); headerNote.innerText=`Ø§Ù†Ø·Ù„Ù‚ Ù…Ù†: ${pad(now.getHours())}:${pad(now.getMinutes())} â€” Ø¬Ø¯ÙˆÙ„ Ù…Ø³ØªØ¹Ø§Ø¯`;
  timelineEl.appendChild(headerNote);
  currentSchedule.studySlots.forEach(s=>{ let slotEl; if(s.type==='study'){ slotEl = makeStudySlot(s.subject,s.start,s.finish); }
    else if(s.type==='break'){ slotEl = makeBreakSlot(s.start,s.finish); }
    else if(s.type==='prayer'){ slotEl = makePrayerSlot(s.name,s.start,s.finish); }
    timelineEl.appendChild(slotEl);
  });
  updateSummaries(); startSlotTimer();
}

// ======= Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ =======
window.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ e.preventDefault(); // toggle done on first study slot visible
    const firstStudy = timelineEl.querySelector('.slot.study'); if(firstStudy) { firstStudy.classList.toggle('done'); updateSummaries(); }
  }
  if(e.key.toLowerCase() === 'r'){ regenBtn.click(); }
});

// ======= ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ø­ÙÙˆØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯) =======
window.addEventListener('load', ()=>{
  const saved = loadScheduleFromStorage(); if(saved){ // Ù„Ø§ Ù†ÙØ±Ø¶ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ â€” ÙÙ‚Ø· Ù†Ø¹Ø±Ø¶
    // Ø¹Ø±Ø¶ Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ù…Ø±Ø­Ø¨
    statusEl.innerText = 'Ø¬Ø¯ÙˆÙ„ Ù…Ø­ÙÙˆØ¸ Ù…ÙˆØ¬ÙˆØ¯ â€” Ø§Ø¶ØºØ· "ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„" Ù„Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡.';
  }
});

// ========= Ù…Ø³Ø§Ø¹Ø¯Ø© ØµØºÙŠØ±Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (safety) =========
// (Ù„Ø§ Ù…Ø§Ù†Ø¹ Ù…Ù† Ø¥Ø¶Ø§ÙØ© ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§ â€” Ø­ÙØ¸Øª Ù„Ùƒ Ù†Ø³Ø®Ø© Ù…Ù† currentSchedule ÙÙŠ localStorage Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹ ÙˆØ§Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠ)

</script>

</body>
</html>
