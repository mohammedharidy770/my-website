<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Time Map</title>
  <!-- ÙØ§ÙÙŠÙƒÙˆÙ† Ù…Ù† Ø±Ø§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠ -->
  <link rel="icon" href="https://img.icons8.com/?size=100&id=11764&format=png&color=228BE6" type="image/png">
<style>
:root{
--bg:#0a192f;
--card:#112240;
--muted:#a0bcd8;
--accent:#64ffda;
--glass:rgba(255,255,255,0.03);
--prayer-bg: rgba(100,255,218,0.08);
--prayer-border: rgba(100,255,218,0.25);
--done-bg: rgba(100,255,218,0.22);
--highlight:#64ffda;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Cairo',sans-serif;background:linear-gradient(180deg,var(--bg),#05020a);color:#eceff8;padding:16px}
header{text-align:center;margin-bottom:14px}
h1{font-size:22px;margin-bottom:6px}
.lead{color:var(--muted);font-size:13px;margin-bottom:12px}
.app{max-width:1200px;margin:0 auto;display:flex;gap:14px;align-items:flex-start}
.main{flex:1}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.controls{display:flex;gap:10px;align-items:center;margin-bottom:12px}
.btn{padding:10px 14px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer;color:inherit}
.btn.primary{background:linear-gradient(180deg,rgba(164,108,255,0.18),transparent);border-color:rgba(164,108,255,0.35)}
.small{font-size:13px;padding:6px 10px}
.timeline{display:flex;flex-direction:column;gap:8px;position:relative}
.slot{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center;transition:background 0.3s ease,color 0.3s ease}
.slot .left{display:flex;flex-direction:column;align-items:flex-end}
.slot .left strong{font-size:15px}
.slot .left small{color:var(--muted)}
.slot .time small{color:var(--muted);font-size:13px}
.slot.study{cursor:pointer;background:transparent}
.slot.done{background:var(--done-bg);color:#fff;text-decoration:line-through}
.slot.prayer{background:var(--prayer-bg);border-color:var(--prayer-border);color:var(--accent);font-weight:700;justify-content:center;cursor:default}
.slot.break{background:rgba(255,255,255,0.01);font-style:italic;color:var(--muted)}
.slot.highlight{background:var(--highlight);animation:flash 0.8s ease-in-out;}
@keyframes flash{0%{background:var(--highlight);}50%{background:var(--card);}100%{background:var(--highlight);}}
aside{width:360px}
.label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,textarea,select{width:100%;padding:10px;border-radius:8px;background:#0a0710;border:1px solid rgba(255,255,255,0.03);color:inherit;margin-bottom:10px}
.summary{margin-top:10px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px;font-size:14px;color:var(--muted)}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{width:calc(100% - 40px);max-width:640px;background:linear-gradient(180deg,#12031b,#0b0512);border-radius:12px;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,0.7);color:#fff}
.modal h3{margin:0 0 8px 0;color:var(--accent)}
.modal .content{color:var(--muted);margin-bottom:12px}
.modal .actions{display:flex;justify-content:flex-end;gap:8px}
.notice{
  display:none;
  position:sticky;
  top:8px;
  z-index:999;
  margin-bottom:8px;
  padding:10px 12px;
  background:var(--notice-bg);
  border-radius:8px;
  color:#fff;
  font-weight:700;
  box-shadow:0 8px 20px rgba(0,0,0,0.6);
  text-align:center;
}
@media(max-width:900px){ .app{flex-direction:column} aside{width:100%} .modal{width:92%} }
</style>
</head>
<body>
<header>
  <h1>Ù†Ø¸Ù‘Ù… ÙŠÙˆÙ…Ùƒ â€” Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¢Ù†</h1>
  <div class="lead">Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…" ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„ Ø³ÙŠØ¨Ø¯Ø£ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù…Ø¯Ø© 8 Ø³Ø§Ø¹Ø§Øª Ù…Ø°Ø§ÙƒØ±Ø© (Ù…ÙˆØ²Ø¹Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§). Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ø¯Ù…Ø¬Ø© ÙˆØ¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©.</div>
</header>

<div class="app">
  <main class="main">
    <div class="card">
      <div class="controls">
        <button class="btn primary" id="startBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="btn" id="regenBtn">ğŸ” Ø£Ø¹Ø¯ ØªÙˆØ²ÙŠØ¹</button>
        <div style="margin-left:auto" class="small" id="status">Ø¬Ø§Ù‡Ø²</div>
      </div>

      <div id="notice" class="notice"></div>

      <div id="timeline" class="timeline">
        <div style="color:var(--muted);text-align:center;padding:20px">Ù„Ù… ØªØ¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ… Ø¨Ø¹Ø¯ â€” Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ.</div>
      </div>
      <div class="summary" id="todaySummary" style="margin-top:12px">
        Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…: â€” Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯
      </div>
    </div>
  </main>

  <aside>
    <div class="card">
      <h4>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h4>
      <label class="label">Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
      <input type="number" id="prayerDuration" value="30">
      <label class="label">Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ±Ø§Ø­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø¯Ù‚ÙŠÙ‚Ø©)</label>
      <input type="number" id="breakMinutes" value="15">
      <label class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</label>
      <input type="text" id="cityInput" value="Cairo">
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn primary" id="applyBtn">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h4>Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ â€” Ø§ÙƒØªØ¨Ù‡Ø§ Ù‡Ù†Ø§</h4>
      <label class="label">Ø§ÙƒØªØ¨ Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±</label>
      <textarea id="appointments" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø§Ù„Ø®Ù…ÙŠØ³ 6 Ù…Ø³Ø§Ø¡Ù‹"></textarea>
      <button class="btn primary" id="saveAppointments">ğŸ’¾ Ø§Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</button>
      <div class="summary" style="margin-top:8px">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ ÙˆØ³ÙŠØªÙ… Ø¹Ø±Ø¶Ù‡Ø§ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.</div>
    </div>

    <div class="card" style="margin-top:12px" id="swapSubjectsCard">
      <h4>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„</h4>
      <label class="label">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</label>
      <input type="number" id="swapIndex1" min="1" placeholder="Ù…Ø«Ø§Ù„: 1">
      <label class="label">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</label>
      <input type="number" id="swapIndex2" min="1" placeholder="Ù…Ø«Ø§Ù„: 5">
      <label class="label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù€16 Ù…Ø§Ø¯Ø©</label>
      <select id="newSubjectSelect">
        <option value="">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø©</option>
        <option value="Ø±ÙŠØ§Ø¶Ø©">Ø±ÙŠØ§Ø¶Ø©</option>
        <option value="Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ">Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ</option>
        <option value="ÙÙŠØ²ÙŠØ§Ø¡">ÙÙŠØ²ÙŠØ§Ø¡</option>
        <option value="ÙƒÙŠÙ…ÙŠØ§Ø¡">ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
        <option value="Ø£Ø­ÙŠØ§Ø¡">Ø£Ø­ÙŠØ§Ø¡</option>
        <option value="Ù‚Ø±Ø¢Ù†">Ù‚Ø±Ø¢Ù†</option>
        <option value="Ø­Ø¯ÙŠØ«">Ø­Ø¯ÙŠØ«</option>
        <option value="ØªÙØ³ÙŠØ±">ØªÙØ³ÙŠØ±</option>
        <option value="ØªÙˆØ­ÙŠØ¯">ØªÙˆØ­ÙŠØ¯</option>
        <option value="ÙÙ‚Ù‡">ÙÙ‚Ù‡</option>
        <option value="ØµØ±Ù">ØµØ±Ù</option>
        <option value="Ø£Ø¯Ø¨">Ø£Ø¯Ø¨</option>
        <option value="Ù†ØµÙˆØµ">Ù†ØµÙˆØµ</option>
        <option value="ØªØ¹Ø¨ÙŠØ±">ØªØ¹Ø¨ÙŠØ±</option>
        <option value="Ø¨Ù„Ø§ØºØ©">Ø¨Ù„Ø§ØºØ©</option>
        <option value="Ù†Ø­Ùˆ">Ù†Ø­Ùˆ</option>
      </select>
      <button class="btn primary" id="swapBtn">ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø©</button>
      <div class="summary" style="margin-top:8px">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¨Ø¯ÙŠÙ„ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ù…Ø§Ø¯Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "ØªØ¨Ø¯ÙŠÙ„ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø§Ø¯Ø©".</div>
    </div>
  </aside>
</div>

<!-- Ù…Ù„Ù Ø§Ù„ØµÙˆØª: Ping ÙˆØ§Ø¶Ø­ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª -->
<!-- Ø§Ø³ØªØ®Ø¯Ù…Øª Ù…Ù„Ù mp3 Ø®ÙÙŠÙ Ù…Ù† Ù…ÙƒØªØ¨Ø© ØµÙˆØªÙŠØ© Ø¹Ø§Ù…Ø© -->
<audio id="pingAudio" preload="auto" src="https://www.soundjay.com/button/sounds/beep-07.mp3"></audio>

<div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h3>Ø§Ù†ØªÙ‡Øª 8 Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© â€” ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
    <div id="modalContent" class="content">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div class="actions">
      <button class="btn" id="closeModal">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>
</div>

<script>
// ======= Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© =======
const SUBJECT_POOL = [
  {name:'Ø±ÙŠØ§Ø¶Ø©', dur:120},{name:'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', dur:120},{name:'ÙÙŠØ²ÙŠØ§Ø¡', dur:120},{name:'ÙƒÙŠÙ…ÙŠØ§Ø¡', dur:120},{name:'Ø£Ø­ÙŠØ§Ø¡', dur:120},
  {name:'Ù‚Ø±Ø¢Ù†', dur:60},{name:'Ø­Ø¯ÙŠØ«', dur:60},{name:'ØªÙØ³ÙŠØ±', dur:60},{name:'ØªÙˆØ­ÙŠØ¯', dur:60},{name:'ÙÙ‚Ù‡', dur:60},
  {name:'ØµØ±Ù', dur:60},{name:'Ø£Ø¯Ø¨', dur:60},{name:'Ù†ØµÙˆØµ', dur:60},{name:'ØªØ¹Ø¨ÙŠØ±', dur:60},{name:'Ø¨Ù„Ø§ØºØ©', dur:60},{name:'Ù†Ø­Ùˆ', dur:60}
];

const startBtn = document.getElementById('startBtn');
const regenBtn = document.getElementById('regenBtn');
const statusEl = document.getElementById('status');
const timelineEl = document.getElementById('timeline');
const todaySummaryEl = document.getElementById('todaySummary');
const prayerDurationInput = document.getElementById('prayerDuration');
const breakMinutesInput = document.getElementById('breakMinutes');
const cityInput = document.getElementById('cityInput');
const applyBtn = document.getElementById('applyBtn');
const appointmentsInput = document.getElementById('appointments');
const saveAppointmentsBtn = document.getElementById('saveAppointments');
const swapBtn = document.getElementById('swapBtn');
const noticeEl = document.getElementById('notice');
const pingAudio = document.getElementById('pingAudio');

function pad(n){ return String(n).padStart(2,'0'); }
function toTime(mins){ const h=Math.floor(mins/60); const m=mins%60; return `${pad(h)}:${pad(m)}`; }
function hhmmToMinutes(str){ if(!str) return null; const match = str.match(/(\d{1,2}):(\d{2})/); if(!match) return null; return parseInt(match[1],10)*60 + parseInt(match[2],10); }
// function applyRandomTheme() {
//   const themeNumber = Math.floor(Math.random() * 10) + 1;
//   document.documentElement.style.setProperty('--bg', getComputedStyle(document.documentElement).getPropertyValue(`--bg-${themeNumber}`));
//   document.documentElement.style.setProperty('--card', getComputedStyle(document.documentElement).getPropertyValue(`--card-${themeNumber}`));
//   document.documentElement.style.setProperty('--muted', getComputedStyle(document.documentElement).getPropertyValue(`--muted-${themeNumber}`));
//   document.documentElement.style.setProperty('--accent', getComputedStyle(document.documentElement).getPropertyValue(`--accent-${themeNumber}`));
//   document.documentElement.style.setProperty('--glass', getComputedStyle(document.documentElement).getPropertyValue(`--glass-${themeNumber}`));
//   document.documentElement.style.setProperty('--prayer-bg', getComputedStyle(document.documentElement).getPropertyValue(`--prayer-bg-${themeNumber}`));
//   document.documentElement.style.setProperty('--prayer-border', getComputedStyle(document.documentElement).getPropertyValue(`--prayer-border-${themeNumber}`));
//   document.documentElement.style.setProperty('--done-bg', getComputedStyle(document.documentElement).getPropertyValue(`--done-bg-${themeNumber}`));
//   document.documentElement.style.setProperty('--highlight', getComputedStyle(document.documentElement).getPropertyValue(`--highlight-${themeNumber}`));
// }

// // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø«ÙŠÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙŠÙˆÙ…"
// startBtn.addEventListener('click', ()=>{
//   applyRandomTheme();
//   startDay();
// });

// seeded shuffle (same ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ)
function seededRandom(seed){ let s=0; for(let i=0;i<seed.length;i++){ s = (s * 31 + seed.charCodeAt(i)) >>> 0; } return function(){ s = (s ^ (s<<13)) >>> 0; s = (s ^ (s>>>17)) >>> 0; s = (s ^ (s<<5)) >>> 0; return (s >>> 0) / 4294967295; } }
function shuffleWithSeed(arr, seed){
  const rnd = seededRandom(seed);
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){ const j = Math.floor(rnd()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

// ======= Ù…ÙˆØ§Ø¹ÙŠØ¯ =======
const APPOINT_KEY = 'nazem_day_appointments_v1';
function loadAppointments(){ const raw = localStorage.getItem(APPOINT_KEY); if(raw) appointmentsInput.value = raw; }
function saveAppointments(){ localStorage.setItem(APPOINT_KEY, appointmentsInput.value); alert('ØªÙ… Ø­ÙØ¸ Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ù…Ø­Ù„ÙŠÙ‹Ø§'); }
saveAppointmentsBtn.addEventListener('click', saveAppointments);
loadAppointments();

// ======= Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª =======
function makeStudySlot(subject,start,finish){
  const el = document.createElement('div'); el.className='slot study';
  const left = document.createElement('div'); left.className='left';
  const strong = document.createElement('strong'); strong.innerText=subject;
  const small = document.createElement('small'); small.innerText=`${toTime(start)} - ${toTime(finish)}`;
  left.appendChild(strong); left.appendChild(small);
  el.appendChild(left);
  el.addEventListener('click', ()=>{ el.classList.toggle('done'); updateSummaries(); });
  return el;
}
function makePrayerSlot(name,start,finish){
  const el = document.createElement('div'); el.className='slot prayer';
  el.innerText=`${name} â€” ${toTime(start)} - ${toTime(finish)}`;
  return el;
}
function makeBreakSlot(start,finish){
  const el = document.createElement('div'); el.className='slot break';
  el.innerText=`Ø§Ø³ØªØ±Ø§Ø­Ø© â€” ${toTime(start)} - ${toTime(finish)}`;
  return el;
}

// ======= ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ =======
let currentSchedule = null;
function updateSummaries(){
  if(!currentSchedule) return;
  const studySlots = currentSchedule.studySlots.filter(s=>s.type==='study');
  const done = studySlots.filter((s,i)=>{
    const el = timelineEl.querySelectorAll('.slot.study')[i];
    return el && el.classList.contains('done');
  }).length;
  todaySummaryEl.innerText = `Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…: ${done} Ù…Ù† ${studySlots.length} Ù…Ø§Ø¯Ø© ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡Ø§`;
}

// ======= Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ù† Aladhan =======
async function fetchPrayerTimingsForCity(city){
  const country = 'Egypt'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ - Ù…Ù…ÙƒÙ† Ù†Ø¶ÙŠÙ Ø®Ø§Ù†Ø© Ø¨Ù„Ø¯ Ù„Ø§Ø­Ù‚Ù‹Ø§
  try{
    const url = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=2`;
    const res = await fetch(url);
    const json = await res.json();
    if(json && json.data && json.data.timings){
      const t = json.data.timings;
      return { Fajr: t.Fajr, Dhuhr: t.Dhuhr, Asr: t.Asr, Maghrib: t.Maghrib, Isha: t.Isha };
    }
  }catch(e){
    console.error('prayer API error', e);
  }
  return null;
}

// ======= Ù…Ø³Ø¬Ù„Ø§Øª Ù…Ø¤Ù‚ØªØ© Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø­ØªÙ‰ Ù„Ø§ ØªØªÙƒØ±Ø± =======
let scheduledTimers = []; // Ù„ØªØ®Ø²ÙŠÙ† setTimeout ids Ø­ØªÙ‰ ÙŠÙ…ÙƒÙ† Ø¥Ù„ØºØ§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ²ÙŠØ¹
let playedPrayers = new Set();
startBtn.addEventListener('click', ()=>{ startDay(); });

// ÙˆØ¸ÙŠÙØ© Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†ÙŠ Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ ØµÙ„Ø§Ø©
function triggerPrayerAlert(prayerName){
  // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
  if(playedPrayers.has(prayerName)) return;
  playedPrayers.add(prayerName);

  // Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù†ØµÙŠ
  noticeEl.innerText = `ğŸ•Œ Ø­Ø§Ù† Ø§Ù„Ø¢Ù† Ù…ÙˆØ¹Ø¯ ØµÙ„Ø§Ø© ${prayerName}`;
  noticeEl.style.display = 'block';

  // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª (Ù…Ø±Ù‘Ø© ÙˆØ§Ø­Ø¯Ø©) Ø«Ù… Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø¨Ø¹Ø¯ 10s
  try{
    // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ù„Ùˆ Ø§Ø­ØªØ§Ø¬
    pingAudio.currentTime = 0;
    const playPromise = pingAudio.play();
    // play() ÙŠØ±Ø¬Ø¹ Promise ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
    if(playPromise !== undefined){
      playPromise.catch(err => {
        // Ù‚Ø¯ ÙŠÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ Ø±ÙØ¶ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ â€” Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¶ØºØ· Ø²Ø± "Ø§Ø¨Ø¯Ø£" ÙØªÙƒÙˆÙ† Ù…ØµØ±Ø­ Ø¨Ù‡Ø§ Ø¹Ø§Ø¯Ø©
        console.warn('play failed', err);
      });
    }
    // Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ Ù†ÙˆÙ‚Ù Ø§Ù„ØµÙˆØª ÙˆÙ†Ø®ÙÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
    setTimeout(()=>{
      try{ pingAudio.pause(); pingAudio.currentTime = 0; }catch(e){}
      noticeEl.style.display = 'none';
    }, 10000);
  }catch(e){
    console.error('audio error', e);
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†ÙŠ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„ØµÙˆØª ÙØ´Ù„
    setTimeout(()=>{ noticeEl.style.display = 'none'; }, 10000);
  }
}

// ======= Ø¨Ø¯Ø¡ Ø§Ù„ÙŠÙˆÙ… Ù…Ø¹ Ù…ÙˆØ§Ù‚ÙŠØª Ø­Ù‚ÙŠÙ‚ÙŠØ© ÙˆÙ‚Ø·Ø¹ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© =======
async function startDay(){
  // Ù†Ø¸Ù Ø£ÙŠ Ù…Ø¤Ù‚ØªØ§Øª Ø³Ø§Ø¨Ù‚Ø©
  scheduledTimers.forEach(id=>clearTimeout(id));
  scheduledTimers = [];
  playedPrayers.clear();

  statusEl.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...';
  const prayerDur = Number(prayerDurationInput.value) || 30;
  const breakMinDefault = Number(breakMinutesInput.value) || 5;
  const seed = (new Date()).toISOString().slice(0,10);
  const subjects = pickSubjects(seed);
  const now = new Date();
  const startMinutes = now.getHours()*60 + now.getMinutes();
  const dayWindowEnd = startMinutes + 8*60;

  // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const headerNote = document.createElement('div');
  headerNote.style.color='var(--muted)';
  headerNote.style.textAlign='center';
  headerNote.style.padding='6px 0';
  headerNote.innerText=`Ø§Ù†Ø·Ù„Ù‚ Ù…Ù†: ${pad(now.getHours())}:${pad(now.getMinutes())} â€” Ù…Ø¯Ø© Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: 8 Ø³Ø§Ø¹Ø§Øª`;

  // Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
  const city = (cityInput.value || 'Cairo').trim();
  const apiTimings = await fetchPrayerTimingsForCity(city);
  const prayerNamesMap = { Fajr:'Ø§Ù„ÙØ¬Ø±', Dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', Asr:'Ø§Ù„Ø¹ØµØ±', Maghrib:'Ø§Ù„Ù…ØºØ±Ø¨', Isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡' };
  const prayersList = [];

  if(apiTimings){
    for(const key of ['Fajr','Dhuhr','Asr','Maghrib','Isha']){
      const hhmm = apiTimings[key];
      const mins = hhmmToMinutes(hhmm);
      if(mins !== null){
        // Ù†Ø¶ÙŠÙ ÙÙ‚Ø· Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„ØªÙŠ ØªÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
        if(mins >= startMinutes && mins < dayWindowEnd){
          prayersList.push({name:prayerNamesMap[key], mins});
        }
      }
    }
    prayersList.sort((a,b)=>a.mins-b.mins);
  }else{
    // ÙØ´Ù„ API â†’ Ù†Ø³ØªÙ…Ø± Ø¨Ø¯ÙˆÙ† ØµÙ„ÙˆØ§Øª Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± fallback Ù„Ø§Ø­Ù‚Ù‹Ø§
    console.warn('Ù„Ù… ÙŠØªÙ… Ø¬Ù„Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©.');
  }

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØµÙ„Ø§Ø©
  const schedule = [];
  let current = startMinutes;

  for(let i=0;i<subjects.length && current < dayWindowEnd;i++){
    let subj = subjects[i];
    let remaining = subj.dur;
    while(remaining > 0 && current < dayWindowEnd){
      // Ø¥ÙŠØ¬Ø§Ø¯ Ø£ÙˆÙ„ ØµÙ„Ø§Ø© Ù‚Ø§Ø¯Ù…Ø© Ø¨Ø¹Ø¯ Ø£Ùˆ Ø¹Ù†Ø¯ current
      const nextPrayerIndex = prayersList.findIndex(p => p.mins >= current && p.mins < dayWindowEnd);
      const nextPrayer = nextPrayerIndex !== -1 ? prayersList[nextPrayerIndex] : null;

      if(nextPrayer && nextPrayer.mins < current + remaining){
        // Ù‚Ø³Ù… Ø§Ù„Ø¯Ø±Ø§Ø³Ø© Ø­ØªÙ‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø©
        const studyEnd = nextPrayer.mins;
        if(studyEnd > current){
          schedule.push({type:'study', subject:subj.name, start:current, finish:studyEnd});
          remaining -= (studyEnd - current);
          current = studyEnd;
        }
        // Ø£Ø¶Ù ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© (Ù…Ø¯Ø© prayerDur)
        schedule.push({type:'prayer', name: nextPrayer.name, start: current, finish: current + prayerDur});
        // Ø­Ø±Ùƒ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©
        current += prayerDur;
        // Ù†Ø²ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§ÙŠÙ…Ø© Ø­ØªÙ‰ Ù„Ø§ Ù†ÙƒØ±Ø±Ù‡Ø§
        prayersList.splice(nextPrayerIndex,1);
      } else {
        // Ù„Ø§ ØµÙ„Ø§Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ -> Ø£Ø¶Ù Ø§Ù„Ø¯Ø±Ø§Ø³Ø© ÙƒØ§Ù…Ù„Ø© Ø£Ùˆ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Ø§ÙØ°Ø©
        const studyEnd = Math.min(current + remaining, dayWindowEnd);
        if(studyEnd > current){
          schedule.push({type:'study', subject:subj.name, start:current, finish:studyEnd});
          remaining -= (studyEnd - current);
          current = studyEnd;
        } else {
          remaining = 0;
        }
      }
    }

    // Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªØ±Ø§Ø­Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø¥Ù† ÙƒØ§Ù† Ù„Ø¯ÙŠÙ‡Ø§ ÙˆÙ‚Øª ÙˆØ¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
    if(i < subjects.length - 1 && current < dayWindowEnd && breakMinDefault > 0){
      schedule.push({type:'break', start: current, finish: Math.min(current + breakMinDefault, dayWindowEnd)});
      current += breakMinDefault;
    }
  }

  // Ø£Ø¶Ù Ø£ÙŠ ØµÙ„Ø§Ø© Ù…ØªØ¨Ù‚ÙŠØ© ØªÙ‚Ø¹ Ø¨Ø¹Ø¯ current Ù„ÙƒÙ† Ø¯Ø§Ø®Ù„ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Ø§ÙØ°Ø©
  for(const p of prayersList.slice()){
    if(p.mins >= startMinutes && p.mins < dayWindowEnd && p.mins >= current){
      if(p.mins > current) current = p.mins;
      schedule.push({type:'prayer', name:p.name, start:current, finish:current + prayerDur});
      current += prayerDur;
    }
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØµÙØ­Ø©
  timelineEl.innerHTML = '';
  timelineEl.appendChild(headerNote);
  for(const s of schedule){
    let slotEl;
    if(s.type==='study'){ slotEl = makeStudySlot(s.subject,s.start,s.finish); }
    else if(s.type==='break'){ slotEl = makeBreakSlot(s.start,s.finish); }
    else if(s.type==='prayer'){ slotEl = makePrayerSlot(s.name,s.start,s.finish); }
    timelineEl.appendChild(slotEl);
  }

  currentSchedule = {studySlots: schedule};
  updateSummaries();
  statusEl.innerText = `Ø§Ù„ÙŠÙˆÙ… Ø¬Ø§Ø±ÙŠ â€” Ù…ÙˆØ§Ù‚ÙŠØª Ù…Ù†: ${city}`;

  // Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©/Ø§Ù„Ù†ØµÙŠØ© Ù„ÙƒÙ„ ØµÙ„Ø§Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„ØªÙŠ Ù„Ù… ØªÙØ±ÙÙ† Ø¨Ø¹Ø¯)
  // Ù†Ø­Ø³Ø¨ ØªÙˆÙ‚ÙŠØª ÙƒÙ„ ØµÙ„Ø§Ø© ÙƒÙ†Ù‚Ø·Ø© Ø²Ù…Ù†ÙŠØ© Ù…Ø·Ù„Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…
  const nowMs = Date.now();
  schedule.forEach(s => {
    if(s.type === 'prayer'){
      // Ø£Ù†Ø´Ø¦ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© s.start
      const today = new Date();
      const target = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, s.start, 0, 0);
      const delay = target.getTime() - nowMs;
      if(delay >= 0){
        // Ø¶Ø¨Ø· Ù…Ø¤Ù‚Øª Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
        const id = setTimeout(()=> {
          triggerPrayerAlert(s.name);
        }, delay);
        scheduledTimers.push(id);
      } else {
        // Ø¥Ø°Ø§ ÙˆÙ‚Øª Ø§Ù„ØµÙ„Ø§Ø© Ù…Ø¶Ù‰ Ø­Ø¯ÙŠØ«Ù‹Ø§ (Ù‚Ø±ÙŠØ¨Ù‹Ø§) Ù„ÙƒÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙŠØ­ØªÙˆÙŠÙ‡Ø§ØŒ Ù†Ø·Ù„Ù‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙÙˆØ±Ù‹Ø§
        // Ù‡Ø°Ø§ ÙŠØºØ·ÙŠ Ø­Ø§Ù„Ø© ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¶ØºØ· Ø¨Ø¹Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø© Ø¨Ù‚Ù„ÙŠÙ„
        if((Date.now() - target.getTime()) < 60*1000){ // Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø©
          // Ø´ØºÙ‘Ù„ ÙÙˆØ±Ù‹Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
          triggerPrayerAlert(s.name);
        }
      }
    }
  });
}

// ======= ØªØ¨Ø¯ÙŠÙ„ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¯ =======
swapBtn.addEventListener('click', ()=>{
  if(!currentSchedule) return alert('Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯.');
  const idx1 = parseInt(document.getElementById('swapIndex1').value)-1;
  const idx2 = parseInt(document.getElementById('swapIndex2').value)-1;
  const newSubj = document.getElementById('newSubjectSelect').value;
  const studySlots = currentSchedule.studySlots.filter(s=>s.type==='study');
  if(isNaN(idx1) || idx1<0 || idx1>=studySlots.length) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø§Ø¯Ø© ØµØ­ÙŠØ­Ø©');
  if(idx2!==-1 && (isNaN(idx2) || idx2<0 || idx2>=studySlots.length)) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù…Ø§Ø¯Ø© Ø«Ø§Ù†ÙŠØ© ØµØ­ÙŠØ­Ø©');

  if(newSubj){ studySlots[idx1].subject = newSubj; studySlots[idx1].highlight=true; }
  if(!newSubj && idx2!==-1){ const temp=studySlots[idx1].subject; studySlots[idx1].subject=studySlots[idx2].subject; studySlots[idx2].subject=temp; }

  // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ currentSchedule
  timelineEl.innerHTML = '';
  const headerNote = document.createElement('div');
  headerNote.style.color='var(--muted)'; headerNote.style.textAlign='center'; headerNote.style.padding='6px 0';
  const now = new Date();
  headerNote.innerText=`Ø§Ù†Ø·Ù„Ù‚ Ù…Ù†: ${pad(now.getHours())}:${pad(now.getMinutes())} â€” Ù…Ø¯Ø© Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: 8 Ø³Ø§Ø¹Ø§Øª`;
  timelineEl.appendChild(headerNote);

  currentSchedule.studySlots.forEach((s,i)=>{
    let slotEl;
    if(s.type==='study'){ slotEl = makeStudySlot(s.subject,s.start,s.finish);
      if(s.highlight){ slotEl.classList.add('highlight'); setTimeout(()=>slotEl.classList.remove('highlight'),800); s.highlight=false; } }
    else if(s.type==='break'){ slotEl = makeBreakSlot(s.start,s.finish); }
    else if(s.type==='prayer'){ slotEl = makePrayerSlot(s.name,s.start,s.finish); }
    timelineEl.appendChild(slotEl);
  });

  updateSummaries();
  alert('ØªÙ… ØªØ­Ø¯ÙŠØ« / ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
});

// ======= Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =======
startBtn.addEventListener('click', startDay);
regenBtn.addEventListener('click', startDay);
applyBtn.addEventListener('click',()=>{ startDay(); alert('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'); });

// ======= Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ =======
function pickSubjects(seed){
  const shuffled = shuffleWithSeed(SUBJECT_POOL, seed + '_pool');
  const picks = [];
  let sum = 0;
  const TARGET = 8 * 60
  for(const s of shuffled){
    if(sum + s.dur > TARGET) continue;
    picks.push({...s});
    sum += s.dur;
    if(sum === TARGET) break;
  }
  if(sum < TARGET){
    const smalls = shuffleWithSeed(SUBJECT_POOL.filter(x=>x.dur<=60), seed+'_extras');
    let idx = 0;
    while(sum < TARGET){
      const item = smalls[idx % smalls.length];
      if(sum + item.dur <= TARGET){ picks.push({...item}); sum += item.dur; } else break;
      idx++; if(idx>200) break;
    }
  }
  return picks;
}
</script>
</body>
</html>
